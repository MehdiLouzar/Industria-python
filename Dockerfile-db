# Dockerfile-db

FROM postgis/postgis:14-3.3

# Copie les deux scripts dans initdb.d
COPY db/init/postgis.sql  /docker-entrypoint-initdb.d/
COPY db/init/initDB.sql    /docker-entrypoint-initdb.d/

# Entrypoint :  
# 1) lance init + postgres en tâche de fond  
# 2) attend que le serveur soit prêt  
# 3) exécute tous les .sql par ordre de nommage  
# 4) replace Postgres au premier plan
ENTRYPOINT ["bash", "-mc", "\
  docker-entrypoint.sh postgres & \
  until pg_isready -h localhost -U \"${POSTGRES_USER}\"; do sleep 1; done; \
  for f in /docker-entrypoint-initdb.d/*.sql; do \
    echo \"Applying $f…\"; \
    psql -h localhost -U \"${POSTGRES_USER}\" -d \"${POSTGRES_DB}\" -f \"$f\"; \
  done; \
  fg \
"]
CMD ["postgres"]
